---
sidebar: sidebar 
permalink: trident-use/trident-fsx-storage-backend.html 
keywords: Amazon FSx for NetApp ONTAP, FSx for ONTAP, deploy Trident, integrate Trident, Trident 
summary: 'Utilizzando Trident con Amazon FSx for NetApp ONTAP, puoi garantire che i tuoi cluster Kubernetes in esecuzione in Amazon Elastic Kubernetes Service (EKS) possano fornire volumi persistenti di file e blocchi supportati da ONTAP.' 
---
= Configurare il backend di archiviazione
:hardbreaks:
:allow-uri-read: 
:icons: font
:imagesdir: ../media/




== Integrazione dei driver ONTAP SAN e NAS

Per creare un backend di archiviazione, è necessario creare un file di configurazione in formato JSON o YAML.  Il file deve specificare il tipo di storage desiderato (NAS o SAN), il file system e l'SVM da cui ottenerlo e come autenticarsi.  L'esempio seguente mostra come definire l'archiviazione basata su NAS e utilizzare un segreto AWS per archiviare le credenziali nell'SVM che si desidera utilizzare:

[role="tabbed-block"]
====
.YAML
--
[source, YAML]
----
apiVersion: trident.netapp.io/v1
kind: TridentBackendConfig
metadata:
  name: backend-tbc-ontap-nas
  namespace: trident
spec:
  version: 1
  storageDriverName: ontap-nas
  backendName: tbc-ontap-nas
  svm: svm-name
  aws:
    fsxFilesystemID: fs-xxxxxxxxxx
  credentials:
    name: "arn:aws:secretsmanager:us-west-2:xxxxxxxx:secret:secret-name"
    type: awsarn
----
--
.JSON
--
[source, JSON]
----
{
  "apiVersion": "trident.netapp.io/v1",
  "kind": "TridentBackendConfig",
  "metadata": {
    "name": "backend-tbc-ontap-nas"
    "namespace": "trident"
  },
  "spec": {
    "version": 1,
    "storageDriverName": "ontap-nas",
    "backendName": "tbc-ontap-nas",
    "svm": "svm-name",
    "aws": {
      "fsxFilesystemID": "fs-xxxxxxxxxx"
    },
    "managementLIF": null,
    "credentials": {
      "name": "arn:aws:secretsmanager:us-west-2:xxxxxxxx:secret:secret-name",
      "type": "awsarn"
    }
  }
}

----
--
====
Eseguire i seguenti comandi per creare e convalidare la configurazione del backend Trident (TBC):

* Crea la configurazione del backend Trident (TBC) dal file yaml ed esegui il seguente comando:
+
[source, console]
----
kubectl create -f backendconfig.yaml -n trident
----
+
[listing]
----
tridentbackendconfig.trident.netapp.io/backend-tbc-ontap-nas created
----
* Convalida che la configurazione del backend Trident (TBC) sia stata creata correttamente:
+
[source, console]
----
Kubectl get tbc -n trident
----
+
[listing]
----
NAME                         BACKEND NAME         BACKEND UUID                           PHASE   STATUS

backend-tbc-ontap-nas        tbc-ontap-nas        933e0071-66ce-4324-b9ff-f96d916ac5e9   Bound   Success
----




== Dettagli del driver FSx per ONTAP

È possibile integrare Trident con Amazon FSx for NetApp ONTAP utilizzando i seguenti driver:

* `ontap-san`: Ogni PV fornito è una LUN all'interno del proprio volume Amazon FSx for NetApp ONTAP .  Consigliato per l'archiviazione a blocchi.
* `ontap-nas`: Ogni PV fornito è un volume Amazon FSx for NetApp ONTAP completo.  Consigliato per NFS e SMB.
* `ontap-san-economy`: Ogni PV fornito è una LUN con un numero configurabile di LUN per volume Amazon FSx for NetApp ONTAP .
* `ontap-nas-economy`: Ogni PV fornito è un qtree, con un numero configurabile di qtree per volume Amazon FSx for NetApp ONTAP .
* `ontap-nas-flexgroup`: Ogni PV fornito è un volume Amazon FSx for NetApp ONTAP FlexGroup completo.


Per i dettagli del driver, fare riferimento alink:../trident-use/ontap-nas.html["Driver NAS"] Elink:../trident-use/ontap-san.html["Driver SAN"] .

Una volta creato il file di configurazione, esegui questo comando per crearlo all'interno del tuo EKS:

[source, console]
----
kubectl create -f configuration_file
----
Per verificare lo stato, eseguire questo comando:

[source, console]
----
kubectl get tbc -n trident
----
[listing]
----
NAME                    BACKEND NAME            BACKEND UUID                           PHASE   STATUS
backend-fsx-ontap-nas   backend-fsx-ontap-nas   7a551921-997c-4c37-a1d1-f2f4c87fa629   Bound   Success
----


== Configurazione avanzata del backend ed esempi

Per le opzioni di configurazione del backend, consultare la seguente tabella:

[cols="3"]
|===
| Parametro | Descrizione | Esempio 


| `version` |  | Sempre 1 


| `storageDriverName` | Nome del driver di archiviazione | `ontap-nas`, `ontap-nas-economy` , `ontap-nas-flexgroup` , `ontap-san` , `ontap-san-economy` 


| `backendName` | Nome personalizzato o backend di archiviazione | Nome del driver + "_" + dataLIF 


| `managementLIF` | Indirizzo IP di un cluster o di un LIF di gestione SVM. È possibile specificare un nome di dominio completo (FQDN).  Può essere impostato per utilizzare indirizzi IPv6 se Trident è stato installato utilizzando il flag IPv6.  Gli indirizzi IPv6 devono essere definiti tra parentesi quadre, ad esempio [28e8:d9fb:a825:b7bf:69a8:d02f:9e7b:3555].  Se fornisci il `fsxFilesystemID` sotto il `aws` campo, non è necessario fornire il `managementLIF` perché Trident recupera l'SVM `managementLIF` informazioni da AWS.  Quindi, è necessario fornire le credenziali per un utente sotto l'SVM (ad esempio: vsadmin) e l'utente deve avere il `vsadmin` ruolo. | "10.0.0.1", "[2001:1234:abcd::fefe]" 


| `dataLIF` | Indirizzo IP del protocollo LIF.  * Driver ONTAP NAS*: NetApp consiglia di specificare dataLIF.  Se non specificato, Trident recupera i dataLIF dall'SVM.  È possibile specificare un nome di dominio completo (FQDN) da utilizzare per le operazioni di montaggio NFS, consentendo di creare un DNS round-robin per bilanciare il carico su più dataLIF.  Può essere modificato dopo l'impostazione iniziale. Fare riferimento a .  * Driver ONTAP SAN*: Non specificare per iSCSI.  Trident utilizza ONTAP Selective LUN Map per scoprire gli iSCI LIF necessari per stabilire una sessione multi-percorso.  Se dataLIF è definito in modo esplicito, viene generato un avviso.  Può essere impostato per utilizzare indirizzi IPv6 se Trident è stato installato utilizzando il flag IPv6.  Gli indirizzi IPv6 devono essere definiti tra parentesi quadre, ad esempio [28e8:d9fb:a825:b7bf:69a8:d02f:9e7b:3555]. |  


| `autoExportPolicy` | Abilita la creazione e l'aggiornamento automatici dei criteri di esportazione [Booleano].  Utilizzando il `autoExportPolicy` E `autoExportCIDRs` opzioni, Trident può gestire automaticamente le policy di esportazione. | `false` 


| `autoExportCIDRs` | Elenco di CIDR per filtrare gli IP dei nodi di Kubernetes quando `autoExportPolicy` è abilitato.  Utilizzando il `autoExportPolicy` E `autoExportCIDRs` opzioni, Trident può gestire automaticamente le policy di esportazione. | "["0.0.0.0/0", "::/0"]" 


| `labels` | Insieme di etichette arbitrarie formattate in JSON da applicare ai volumi | "" 


| `clientCertificate` | Valore codificato in Base64 del certificato client.  Utilizzato per l'autenticazione basata su certificato | "" 


| `clientPrivateKey` | Valore codificato in Base64 della chiave privata del client.  Utilizzato per l'autenticazione basata su certificato | "" 


| `trustedCACertificate` | Valore codificato in Base64 del certificato CA attendibile. Opzionale.  Utilizzato per l'autenticazione basata su certificato. | "" 


| `username` | Nome utente per connettersi al cluster o alla SVM. Utilizzato per l'autenticazione basata sulle credenziali.  Ad esempio, vsadmin. |  


| `password` | Password per connettersi al cluster o alla SVM. Utilizzato per l'autenticazione basata sulle credenziali. |  


| `svm` | Macchina virtuale di archiviazione da utilizzare | Derivato se è specificato un managementLIF SVM. 


| `storagePrefix` | Prefisso utilizzato durante il provisioning di nuovi volumi nell'SVM.  Non può essere modificato dopo la creazione.  Per aggiornare questo parametro, sarà necessario creare un nuovo backend. | `trident` 


| `limitAggregateUsage` | *Non specificare per Amazon FSx for NetApp ONTAP.*  Il fornito `fsxadmin` E `vsadmin` non contengono le autorizzazioni richieste per recuperare l'utilizzo aggregato e limitarlo tramite Trident. | Non utilizzare. 


| `limitVolumeSize` | Il provisioning non riesce se la dimensione del volume richiesto è superiore a questo valore. Limita inoltre la dimensione massima dei volumi che gestisce per qtree e LUN e `qtreesPerFlexvol` l'opzione consente di personalizzare il numero massimo di qtree per FlexVol volume | "" (non applicato di default) 


| `lunsPerFlexvol` | Il numero massimo di LUN per volume Flexvol deve essere compreso nell'intervallo [50, 200].  Solo SAN. | "`100`" 


| `debugTraceFlags` | Flag di debug da utilizzare durante la risoluzione dei problemi.  Esempio, {"api":false, "method":true} Non utilizzare `debugTraceFlags` a meno che non si stia risolvendo un problema e si necessiti di un dump di registro dettagliato. | null 


| `nfsMountOptions` | Elenco separato da virgole delle opzioni di montaggio NFS.  Le opzioni di montaggio per i volumi persistenti di Kubernetes sono normalmente specificate nelle classi di archiviazione, ma se non vengono specificate opzioni di montaggio in una classe di archiviazione, Trident utilizzerà le opzioni di montaggio specificate nel file di configurazione del backend di archiviazione.  Se non vengono specificate opzioni di montaggio nella classe di archiviazione o nel file di configurazione, Trident non imposterà alcuna opzione di montaggio su un volume persistente associato. | "" 


| `nasType` | Configurare la creazione di volumi NFS o SMB.  Le opzioni sono `nfs` , `smb` , o nullo.  *Deve essere impostato su `smb` per volumi SMB.*  Impostando il valore su null, i volumi NFS vengono impostati di default. | `nfs` 


| `qtreesPerFlexvol` | Numero massimo di Qtree per FlexVol volume, deve essere compreso nell'intervallo [50, 300] | `"200"` 


| `smbShare` | È possibile specificare uno dei seguenti elementi: il nome di una condivisione SMB creata tramite Microsoft Management Console o ONTAP CLI oppure un nome che consenta a Trident di creare la condivisione SMB.  Questo parametro è obbligatorio per i backend Amazon FSx for ONTAP . | `smb-share` 


| `useREST` | Parametro booleano per utilizzare le API REST ONTAP . Quando impostato su `true` Trident utilizzerà le API REST ONTAP per comunicare con il backend. Questa funzionalità richiede ONTAP 9.11.1 e versioni successive.  Inoltre, il ruolo di accesso ONTAP utilizzato deve avere accesso a `ontap` applicazione.  Ciò è soddisfatto dal predefinito `vsadmin` E `cluster-admin` ruoli. | `false` 


| `aws` | È possibile specificare quanto segue nel file di configurazione per AWS FSx per ONTAP: - `fsxFilesystemID` : Specificare l'ID del file system AWS FSx.  - `apiRegion` : Nome della regione API AWS.  - `apikey` : Chiave API AWS.  - `secretKey` : Chiave segreta AWS. | ``
`` 
`""`
`""`
`""` 


| `credentials` | Specificare le credenziali FSx SVM da archiviare in AWS Secrets Manager.  - `name` : Amazon Resource Name (ARN) del segreto, che contiene le credenziali di SVM.  - `type` : Impostato su `awsarn` .  Fare riferimento alink:https://docs.aws.amazon.com/secretsmanager/latest/userguide/create_secret.html["Crea un segreto AWS Secrets Manager"^] per maggiori informazioni. |  
|===


== Opzioni di configurazione del backend per il provisioning dei volumi

È possibile controllare il provisioning predefinito utilizzando queste opzioni in `defaults` sezione della configurazione.  Per un esempio, vedere gli esempi di configurazione riportati di seguito.

[cols="3"]
|===
| Parametro | Descrizione | Predefinito 


| `spaceAllocation` | Assegnazione dello spazio per LUN | `true` 


| `spaceReserve` | Modalità di prenotazione dello spazio; "nessuno" (sottile) o "volume" (spesso) | `none` 


| `snapshotPolicy` | Criterio di snapshot da utilizzare | `none` 


| `qosPolicy` | Gruppo di criteri QoS da assegnare ai volumi creati.  Scegliere tra qosPolicy o adaptiveQosPolicy per ogni pool di archiviazione o backend.  Per utilizzare i gruppi di policy QoS con Trident è necessario ONTAP 9.8 o versione successiva.  È necessario utilizzare un gruppo di policy QoS non condiviso e assicurarsi che il gruppo di policy venga applicato individualmente a ciascun componente.  Un gruppo di policy QoS condiviso impone il limite massimo per la produttività totale di tutti i carichi di lavoro. | "" 


| `adaptiveQosPolicy` | Gruppo di policy QoS adattivo da assegnare ai volumi creati.  Scegliere tra qosPolicy o adaptiveQosPolicy per ogni pool di archiviazione o backend.  Non supportato da ontap-nas-economy. | "" 


| `snapshotReserve` | Percentuale di volume riservata agli snapshot "0" | Se `snapshotPolicy` È `none` , `else` "" 


| `splitOnClone` | Dividere un clone dal suo genitore al momento della creazione | `false` 


| `encryption` | Abilita NetApp Volume Encryption (NVE) sul nuovo volume; l'impostazione predefinita è `false` .  Per utilizzare questa opzione, NVE deve essere concesso in licenza e abilitato sul cluster.  Se NAE è abilitato sul backend, qualsiasi volume fornito in Trident sarà abilitato per NAE.  Per maggiori informazioni, fare riferimento a:link:../trident-reco/security-reco.html["Come funziona Trident con NVE e NAE"] . | `false` 


| `luksEncryption` | Abilita la crittografia LUKS. Fare riferimento alink:../trident-reco/security-reco.html#Use-Linux-Unified-Key-Setup-(LUKS)["Utilizzare Linux Unified Key Setup (LUKS)"] .  Solo SAN. | "" 


| `tieringPolicy` | Criterio di tiering da utilizzare	`none` |  


| `unixPermissions` | Modalità per nuovi volumi.  *Lasciare vuoto per i volumi SMB.* | "" 


| `securityStyle` | Stile di sicurezza per i nuovi volumi.  Supporti NFS `mixed` E `unix` stili di sicurezza.  Supporti SMB `mixed` E `ntfs` stili di sicurezza. | L'impostazione predefinita di NFS è `unix` .  L'impostazione predefinita di SMB è `ntfs` . 
|===


== Prepararsi al provisioning dei volumi SMB

È possibile eseguire il provisioning dei volumi SMB utilizzando `ontap-nas` autista.  Prima di completare<<Integrazione dei driver ONTAP SAN e NAS>> completare i seguenti passaggi.

.Prima di iniziare
Prima di poter effettuare il provisioning dei volumi SMB utilizzando `ontap-nas` conducente, devi avere quanto segue.

* Un cluster Kubernetes con un nodo controller Linux e almeno un nodo worker Windows che esegue Windows Server 2019.  Trident supporta volumi SMB montati su pod in esecuzione solo su nodi Windows.
* Almeno un segreto Trident contenente le credenziali di Active Directory.  Per generare segreto `smbcreds` :
+
[source, console]
----
kubectl create secret generic smbcreds --from-literal username=user --from-literal password='password'
----
* Un proxy CSI configurato come servizio Windows.  Per configurare un `csi-proxy` , fare riferimento alink:https://github.com/kubernetes-csi/csi-proxy["GitHub: Proxy CSI"^] Olink:https://github.com/Azure/aks-engine/blob/master/docs/topics/csi-proxy-windows.md["GitHub: Proxy CSI per Windows"^] per i nodi Kubernetes in esecuzione su Windows.


.Passi
. Crea condivisioni SMB.  È possibile creare le condivisioni amministrative SMB in uno dei due modi seguenti: utilizzandolink:https://learn.microsoft.com/en-us/troubleshoot/windows-server/system-management-components/what-is-microsoft-management-console["Console di gestione Microsoft"^] Snap-in Cartelle condivise o tramite ONTAP CLI.  Per creare le condivisioni SMB utilizzando ONTAP CLI:
+
.. Se necessario, creare la struttura del percorso della directory per la condivisione.
+
IL `vserver cifs share create` Il comando controlla il percorso specificato nell'opzione -path durante la creazione della condivisione.  Se il percorso specificato non esiste, il comando fallisce.

.. Crea una condivisione SMB associata all'SVM specificato:
+
[source, console]
----
vserver cifs share create -vserver vserver_name -share-name share_name -path path [-share-properties share_properties,...] [other_attributes] [-comment text]
----
.. Verificare che la condivisione sia stata creata:
+
[source, console]
----
vserver cifs share show -share-name share_name
----
+

NOTE: Fare riferimento alink:https://docs.netapp.com/us-en/ontap/smb-config/create-share-task.html["Crea una condivisione SMB"^] per maggiori dettagli.



. Durante la creazione del backend, è necessario configurare quanto segue per specificare i volumi SMB.  Per tutte le opzioni di configurazione del backend FSx for ONTAP , fare riferimento alink:trident-fsx-examples.html["Opzioni di configurazione ed esempi di FSx per ONTAP"] .
+
[cols="3"]
|===
| Parametro | Descrizione | Esempio 


| `smbShare` | È possibile specificare uno dei seguenti elementi: il nome di una condivisione SMB creata tramite Microsoft Management Console o ONTAP CLI oppure un nome che consenta a Trident di creare la condivisione SMB.  Questo parametro è obbligatorio per i backend Amazon FSx for ONTAP . | `smb-share` 


| `nasType` | *Deve essere impostato su `smb` .*  Se nullo, il valore predefinito è `nfs` . | `smb` 


| `securityStyle` | Stile di sicurezza per i nuovi volumi.  *Deve essere impostato su `ntfs` O `mixed` per volumi SMB.* | `ntfs`O `mixed` per volumi SMB 


| `unixPermissions` | Modalità per nuovi volumi.  *Deve essere lasciato vuoto per i volumi SMB.* | "" 
|===

